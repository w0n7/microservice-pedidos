version: "3.9"

services:

  postgres:
    image: postgres:16
    container_name: pedidos-kafka-db
    environment:
      POSTGRES_DB: pedidos-kafka-db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5435:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d pedidos-kafka-db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------
  # KAFKA (KRaft mode - sem Zookeeper)
  # ---------------------------------------
  kafka:
    image: bitnami/kafka:3.7
    container_name: kafka
    ports:
      - "9092:9092"    # interno/cliente
      - "29092:29092"  # host
      - "9999:9999"    # JMX
    environment:
      # Node ID Ãºnico
      KAFKA_NODE_ID: 1

      # Arquivo de metadados Kraft
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093

      # Listeners
      KAFKA_CFG_LISTENERS: INTERNAL://:9092,EXTERNAL://:29092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: INTERNAL://kafka:9092,EXTERNAL://localhost:29092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: INTERNAL
      ALLOW_PLAINTEXT_LISTENER: "yes"

      # Kraft Storage
      KAFKA_CFG_LOG_DIRS: /bitnami/kafka/data
      KAFKA_ENABLE_KRAFT: "yes"

      # JMX para Prometheus
      JMX_PORT: 9999
      KAFKA_JMX_OPTS: "-Dcom.sun.management.jmxremote 
                       -Dcom.sun.management.jmxremote.local.only=false 
                       -Dcom.sun.management.jmxremote.authenticate=false 
                       -Dcom.sun.management.jmxremote.ssl=false"

    volumes:
      - kafka_data:/bitnami/kafka

  # ---------------------------------------
  # KAFDROP - interface web para Kafka
  # ---------------------------------------
  kafdrop:
    image: obsidiandynamics/kafdrop:latest
    container_name: kafdrop
    depends_on:
      - kafka
    ports:
      - "19000:9000"
    environment:
      KAFKA_BROKERCONNECT: kafka:9092

  # ---------------------------------------
  # KAFKA EXPORTER (Prometheus Kafka Metrics)
  # ---------------------------------------
  kafka_exporter:
    image: danielqsj/kafka-exporter:latest
    container_name: kafka_exporter
    command:
      - "--kafka.server=kafka:9092"
    ports:
      - "9308:9308"
    depends_on:
      - kafka

  # ---------------------------------------
  # PROMETHEUS
  # ---------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - kafka_exporter

  # ---------------------------------------
  # GRAFANA
  # ---------------------------------------
  grafana:
    image: grafana/grafana:11.1.0
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    depends_on:
      - prometheus
      - postgres


volumes:
  kafka_data:
  pgdata: