name: CD Pipeline

on:
  push:
    branches: ["main", "dev", "*"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login no DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Docker Image
        run: |
          # ================================
          # 1. Nome do repo (sem o usuário)
          # ================================
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          # ================================
          # 2. Nome da branch -> sem / ou caracteres inválidos
          # ================================
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | tr '/' '-' | tr '[:upper:]' '[:lower:]')

          # ================================
          # 3. SHA curto do commit
          # ================================
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          # ================================
          # 4. Tags da imagem
          # ================================
          IMAGE_BASE="${{ secrets.DOCKERHUB_USER }}/$REPO_NAME"

          TAG_BRANCH="$IMAGE_BASE:$BRANCH_NAME"
          TAG_SHA="$IMAGE_BASE:sha-$SHORT_SHA"

          # Se for branch main → também criar tag latest
          if [ "$BRANCH_NAME" = "main" ]; then
            TAG_LATEST="$IMAGE_BASE:latest"
          fi

          echo "Building image with tags:"
          echo " - $TAG_BRANCH"
          echo " - $TAG_SHA"
          if [ ! -z "$TAG_LATEST" ]; then echo " - $TAG_LATEST"; fi

          # ================================
          # 5. Build da imagem
          # ================================
          docker build -t "$TAG_BRANCH" .

          # Criar outras tags
          docker tag "$TAG_BRANCH" "$TAG_SHA"
          if [ ! -z "$TAG_LATEST" ]; then docker tag "$TAG_BRANCH" "$TAG_LATEST"; fi

          # ================================
          # 6. Push das imagens
          # ================================
          docker push "$TAG_BRANCH"
          docker push "$TAG_SHA"
          if [ ! -z "$TAG_LATEST" ]; then docker push "$TAG_LATEST"; fi
